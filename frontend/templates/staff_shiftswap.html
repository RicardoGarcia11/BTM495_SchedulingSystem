<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Shift Swap</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles/staffshiftswap.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f9f9f9;
      margin: 0;
    }

    nav {
      background-color: #8e44ec;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    nav ul {
      list-style: none;
      display: flex;
      gap: 1.5rem;
      margin: 0;
      padding: 0;
    }

    nav ul li a {
      color: white;
      text-decoration: none;
      font-weight: bold;
    }

    nav ul li a.active {
      background-color: #5a2ca0;
      padding: 6px 12px;
      border-radius: 4px;
    }

    .calendar-container {
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 0 12px rgba(0, 0, 0, 0.05);
    }

    .calendar-header {
      text-align: center;
      font-size: 1.8rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }

    .month-controls {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .month-controls button {
      background-color: #ccc;
      color: #333;
      font-size: 0.8rem;
      border: none;
      padding: 4px 10px;
      border-radius: 5px;
      cursor: pointer;
    }

    .calendar-days,
    .calendar-dates {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      text-align: center;
      gap: 8px;
    }

    .calendar-days div {
      font-weight: bold;
      color: #555;
    }

    .calendar-cell {
      padding: 12px 0;
      background-color: #f0f0f0;
      border-radius: 6px;
      cursor: pointer;
      position: relative;
      min-height: 70px;
      transition: all 0.2s ease;
    }

    .calendar-cell:hover {
      background-color: #e1d9f7;
    }

    .today {
      background-color: #5e2ca5;
      color: white;
    }

    .my-shift {
      background-color: #4caf50;
      color: white;
    }

    .shift-details {
      font-size: 0.75rem;
      margin-top: 5px;
      padding: 0 4px;
    }

    .request-button {
      margin-top: 4px;
      padding: 3px 6px;
      background-color: #8e44ec;
      border: none;
      color: white;
      border-radius: 4px;
      font-size: 0.7rem;
      cursor: pointer;
    }

    .requested-button {
      margin-top: 4px;
      padding: 3px 6px;
      background-color: #bbb;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 0.7rem;
      cursor: default;
    }

    .back-button {
      display: block;
      margin: 2rem auto 0;
      background-color: #8e44ec;
      color: white;
      padding: 12px 24px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
    }

    #flash-message {
      display: none;
      padding: 12px;
      text-align: center;
      font-weight: bold;
      color: white;
    }
  </style>
</head>

<body>
  <nav>
    <ul>
      <li><a href="{{ url_for('staff_dashboard') }}">SCHEDULE</a></li>
      <li><a href="{{ url_for('staff_shiftswap') }}" class="active">SHIFT SWAP</a></li>
      <li><a href="{{ url_for('staff_createavailability') }}">CREATE AVAILABILITY</a></li>
      <li><a href="{{ url_for('staff_timeoff') }}">TIME OFF</a></li>
      <li><a href="{{ url_for('staff_messages') }}">MESSAGES</a></li>
      <li><a href="{{ url_for('staff_log_hours') }}">LOG HOURS</a></li>
    </ul>
    <div class="dropdown">
      <div class="dropdown-toggle">Staff</div>
    </div>
  </nav>

  <div id="flash-message"></div>

  <div class="calendar-container">
    <div class="calendar-header">{{ month_name }} {{ year }}</div>

    <div class="month-controls">
      <form method="get" action="{{ url_for('staff_shiftswap') }}">
        <input type="hidden" name="month" value="{{ prev_month }}">
        <input type="hidden" name="year" value="{{ prev_year }}">
        <button type="submit">&larr;</button>
      </form>
      <form method="get" action="{{ url_for('staff_shiftswap') }}">
        <input type="hidden" name="month" value="{{ next_month }}">
        <input type="hidden" name="year" value="{{ next_year }}">
        <button type="submit">&rarr;</button>
      </form>
    </div>

    <div class="calendar-days">
      <div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
    </div>

    <div class="calendar-dates">
      {% for _ in range((first_weekday + 6) % 7) %}
        <div></div>
      {% endfor %}
      {% for day in range(1, num_days + 1) %}
        {% set shift = shift_map.get(day) %}
        <div class="calendar-cell
          {% if day == today and current_month %} today{% endif %}
          {% if shift and shift.employee_id == current_user_id %} my-shift{% endif %}">
          <strong>{{ day }}</strong>

          {% if shift %}
            <div class="shift-details">
              {{ shift.name }}
              <div>{{ shift.start_time }} - {{ shift.end_time }}</div>

              {% if shift.employee_id != current_user_id %}
                {% if shift.requested %}
                  <button class="requested-button" disabled>Requested</button>
                {% else %}
                <button class="request-button"
                data-requested="{{ my_shift_id if my_shift_id is not none else 'null' }}"
                data-target="{{ shift.shift_id }}"
                onclick="handleSwapClick(this)">
          Request Swap
        </button>
        
                  </button>
                {% endif %}
              {% endif %}
            </div>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  </div>

  <a href="{{ url_for('staff_dashboard') }}">
    <button class="back-button">â¬… Back to Dashboard</button>
  </a>

  <script>
    function handleSwapClick(button) {
      const requestedShiftId = parseInt(button.dataset.requested);
      const targetShiftId = button.dataset.target === 'null' ? null : parseInt(button.dataset.target);

      button.disabled = true;
      button.textContent = "Requesting...";

      fetch("/request_swap", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          requested_shift_id: requestedShiftId,
          target_shift_id: targetShiftId
        })
      })
      .then(async (response) => {
        const data = await response.json();
        const flashDiv = document.getElementById("flash-message");

        flashDiv.textContent = data.message;
        flashDiv.style.display = "block";
        flashDiv.style.backgroundColor = response.ok ? "#4CAF50" : "#f44336";

        if (response.ok) {
          button.className = "requested-button";
          button.textContent = "Requested";
        } else {
          button.disabled = false;
          button.textContent = "Request Swap";
        }

        setTimeout(() => {
          flashDiv.style.display = "none";
        }, 4000);
      })
      .catch(error => {
        const flashDiv = document.getElementById("flash-message");
        flashDiv.textContent = "Failed to submit request.";
        flashDiv.style.display = "block";
        flashDiv.style.backgroundColor = "#f44336";

        button.disabled = false;
        button.textContent = "Request Swap";

        setTimeout(() => {
          flashDiv.style.display = "none";
        }, 4000);
      });
    }
  </script>
</body>
</html>
